<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soluciones Metálicas - Áreas</title>
  <link rel="stylesheet" href="../static/style/App.css">
  <link rel="stylesheet" href="../static/style/modal.css">
  <link rel="stylesheet" href="../static/style/tablas.css">
  <link rel="stylesheet" href="../static/style/forms.css">
  <link rel="stylesheet" href="../static/style/tabla2.css">
  <link rel="icon" href="../static/image/favicon.ico" type="image/x-icon">
</head>
<body>
  <div class="encabezado" >
    <header class="headerprincipal" style="height: 100px;">
    <table>
      <td style="width: fit-content;">
        <div class="imglogo">
          <a href="./gerente.html">
            <img src="../static/image/LOGO.jpeg" alt="Logo" class="logo-img" />
          </a>
        </div>
        <td style="width: 120%">
        <h1 class="bienvenida"><center>¡Bienvenido <span id="nombreUsuario"></span></center> !</h1>
        <h2 class="rolUsuario" hidden><center>Tu rol de usuario es: <span id="rolUsuario"></span></center></h2>
      </td>
      <td style="width: fit-content;">
        <div class="menu-hamburguesa" onclick="toggleMenu()">
          <div class="linea"></div>
          <div class="linea"></div>
          <div class="linea"></div>
        </div>
        <nav id="menu">
          <ul>
            <li><a href="./gerente.html">Página de Bienvenida</a></li>
            <li><a href="./nuevocontrato.html">Nuevo Contrato</a></li>
            <li><a href="./listadocontrato.html">Modificar Presupuestos</a></li>
            <li><a href="./estadocontratos.html">Estado de Contratos</a></li>
            <li><a href="./infocontrato.html">Informes</a></li>
            <li><a href="./index.html">Cerrar Sesión</a></li>
          </ul>
        </nav>
      </td>
    </table>
    </header>

  <main class="main-contentenedor">
    <!-- Contenedor para mostrar las áreas -->
    <div id="areasContainer" class="area-container" style="color:#ffff; font-weight:bold; align-content:center">
      <!-- Aquí se cargarán dinámicamente las áreas y los inputs -->
    </div>

    <!-- Mostrar el presupuesto disponible -->
    <div>
      <br>
      <label for="presupuestoDisplay" style="color: #ffff; font-weight:bold">Presupuesto Disponible:</label>
      <span id="presupuestoDisplay" style="color: #ffff; "></span>
    </div>

    <!-- Botón para asignar presupuesto por área -->
    <button id="asignarPresupuestoButton" class="submit-button">Asignar presupuesto por área</button>
  </main>

  <!-- Ventana modal -->
  <div id="myModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Información de datos registrados</h2>
        <span class="close" hidden>&times;</span>
      </div>
      <div class="modal-body">
        <div class="info-section">
          <h2>Información del Contrato</h2>
          <p><strong>ID Contrato:</strong> <span id="contratoId"></span></p>
          <p><strong>Cliente:</strong> <span id="contratoCliente"></span></p>
          <p><strong>Fecha de Inicio:</strong> <span id="contratoFechaInicio"></span></p>
          <p><strong>Fecha de Fin:</strong> <span id="contratoFechaFin"></span></p>
          <p><strong>Presupuesto:</strong> $<span id="contratoPresupuesto"></span></p>
        </div>
        <div class="info-section">
          <h2>Información del Proyecto</h2>
          <p><strong>ID Proyecto:</strong> <span id="proyectoId"></span></p>
          <p><strong>ID Contrato:</strong> <span id="proyectoContratoId"></span></p>
          <p><strong>ID Producto:</strong> <span id="proyectoProductoId"></span></p>
          <p><strong>Cantidad de Producto:</strong> <span id="proyectoCantidadProducto"></span></p>
          <p><strong>Fecha de Inicio:</strong> <span id="proyectoFechaInicio"></span></p>
          <p><strong>Fecha de Fin:</strong> <span id="proyectoFechaFin"></span></p>
        </div>
        <div class="info-section">
          <h2>Información de Áreas y sus Presupuestos</h2>
          <ul id="areasInfo"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modalAcceptButton" class="submit-button">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const nombreUsuario = localStorage.getItem('nombreUsuario');
      if (nombreUsuario) {
        document.getElementById('nombreUsuario').innerText = nombreUsuario;
       
  }});
    const urlParams = new URLSearchParams(window.location.search);
    const contratoId = urlParams.get('id_contrato');
    const proyectoId = urlParams.get('id_proyecto');
    const presupuesto = urlParams.get('presupuesto');

    document.getElementById('presupuestoDisplay').textContent = `$ ${presupuesto}`;

    async function loadAreas() {
      try {
        const areasResponse = await fetch(`/api/areas?proyecto=${proyectoId}`);
        if (!areasResponse.ok) {
          throw new Error('Error al cargar las áreas');
        }
        const areas = await areasResponse.json();

        const areasContainer = document.getElementById('areasContainer');
        areasContainer.innerHTML = ''; 
        areas.forEach(area => {
          const div = document.createElement('div');
          div.className = 'area-item';
          div.innerHTML = `
            <span>${area.nombre_area}</span> <br>
            <input type="number" id="presupuesto_${area.id_area}" class="form-input" placeholder="Ingrese el presupuesto para ${area.nombre_area}"> <br>
          `;
          areasContainer.appendChild(div);
        });

      } catch (error) {
        console.error(error);
        alert('Error al cargar las áreas: ' + error.message);
      }
    }

      async function asignarPresupuestoPorArea() {
        try {
          const areasResponse = await fetch(`/api/areas?proyecto=${proyectoId}`);
          if (!areasResponse.ok) {
            throw new Error('Error al obtener las áreas');
          }
          const areas = await areasResponse.json();
          let sumaPresupuestos = 0;
    
          const areasData = areas.map(area => {
            const presupuestoInput = document.getElementById(`presupuesto_${area.id_area}`);
            const monto = parseFloat(presupuestoInput.value);
    
            if (isNaN(monto) || monto <= 0) {
              alert(`Ingrese un presupuesto válido para ${area.nombre_area}`);
              throw new Error(`Presupuesto inválido para ${area.nombre_area}`);
            }
    
            sumaPresupuestos += monto;
    
            return {
              id_area: area.id_area,
              nombre_area: area.nombre_area,
              monto
            };
          });
    
          const gananciaResponse = await fetch('/api/reglas/1');
          if (!gananciaResponse.ok) {
            throw new Error('Error al obtener la regla de ganancia');
          }
          const regla = await gananciaResponse.json();
    
          const presupuestoTotal = parseFloat(presupuesto);
          const presupuestoPermitido = presupuestoTotal * (1 - regla.valor / 100);
    
          if (sumaPresupuestos > presupuestoPermitido) {
            alert(`La suma de presupuestos no puede exceder $ ${presupuestoPermitido.toFixed(2)} (${(1 - regla.valor / 100) * 100}% del presupuesto)`);
            return;
          }
    
          const data = {
            id_proyecto: proyectoId,
            id_contrato: contratoId,
            areas: areasData
          };
    
          console.log('Datos a enviar al backend para asignar presupuestos:');
          console.log(data);
    
          const response = await fetch('/api/asignarP/iniciar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });
    
          if (!response.ok) {
            const resultado = await response.json();
            alert(`Error al asignar presupuestos: ${resultado.error}`);
            return;
          }
    
          for (const area of areasData) {
            const estadoareaData = {
              id_estado: 1,
              id_contrato: contratoId,
              id_area: area.id_area,
              id_proyecto: proyectoId
            };
    
            const estadoareaResponse = await fetch('/api/estadoa', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(estadoareaData),
            });
    
            if (!estadoareaResponse.ok) {
              const resultado = await estadoareaResponse.json();
              alert(`Error al crear el estado de área: ${resultado.error}`);
              return;
            }
          }
    
          const contratoResponse = await fetch(`/api/contratos/${contratoId}`);
          if (!contratoResponse.ok) {
            throw new Error('Error al obtener la información del contrato');
          }
          const contrato = await contratoResponse.json();
    
          const proyectoResponse = await fetch(`/api/proyectos/${proyectoId}`);
          if (!proyectoResponse.ok) {
            throw new Error('Error al obtener la información del proyecto');
          }
          const proyecto = await proyectoResponse.json();
    
          const productoResponse = await fetch(`/api/productos/${proyecto.id_producto}`);
          if (!productoResponse.ok) {
            throw new Error('Error al obtener el producto del proyecto');
          }
          const producto = await productoResponse.json();
          console.log(producto.nombre_producto);
    
          document.getElementById('contratoId').textContent = contrato.id_contrato;
          document.getElementById('contratoCliente').textContent = contrato.cliente;
          document.getElementById('contratoFechaInicio').textContent = contrato.fecha_inicio;
          document.getElementById('contratoFechaFin').textContent = contrato.fecha_fin;
          document.getElementById('contratoPresupuesto').textContent = contrato.presupuesto;
    
          document.getElementById('proyectoId').textContent = proyecto.id_proyecto;
          document.getElementById('proyectoContratoId').textContent = proyecto.id_contrato;
          document.getElementById('proyectoProductoId').textContent = producto.nombre_producto;
          document.getElementById('proyectoCantidadProducto').textContent = proyecto.cantidad_producto;
          document.getElementById('proyectoFechaInicio').textContent = proyecto.fecha_inicio;
          document.getElementById('proyectoFechaFin').textContent = proyecto.fecha_fin;
    
          const areasInfo = document.getElementById('areasInfo');
          areasInfo.innerHTML = '';
          areasData.forEach(area => {
            const li = document.createElement('li');
            li.textContent = `${area.nombre_area}: $${area.monto}`;
            areasInfo.appendChild(li);
          });
    
          const modal = document.getElementById('myModal');
          modal.style.display = 'block';
    
        } catch (error) {
          console.error(error);
          alert('Error al asignar presupuestos: ' + error.message);
        }
      }
    
      document.getElementById('asignarPresupuestoButton').addEventListener('click', asignarPresupuestoPorArea);
    
      window.addEventListener('load', loadAreas);
    
      const modal = document.getElementById('myModal');
      const span = document.getElementsByClassName('close')[0];
      const acceptButton = document.getElementById('modalAcceptButton');
    
      span.onclick = function () {
        modal.style.display = 'none';
      }
    
      acceptButton.onclick = function () {
        window.location.href = 'gerente.html';
      }
    
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
      function toggleMenu() {
        const menu = document.getElementById('menu');
        if (menu.style.display === 'block') {
          menu.style.display = 'none';
        } else {
          menu.style.display = 'block';
        }
      }
    </script>
    
</html>

