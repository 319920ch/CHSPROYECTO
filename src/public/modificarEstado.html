<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modificar Estado del Área</title>
    <link rel="stylesheet" href="../static/style/App.css">
    <link rel="stylesheet" href="../static/style/modal.css">
    <link rel="stylesheet" href="../static/style/tabla2.css">
    <link rel="icon" href="../static/image/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="encabezado">
        <header class="headerprincipal">
            <div class="imglogo">
                <a href="./encargado.html"></a>
                <img src="../static/image/LOGO.jpeg" alt="Logo" class="logo-img" />
            </div>
            <h1 class="bienvenida"><center>¡Bienvenido <span id="nombreUsuario"></span></center> !</h1>
            <h2 class="rolUsuario" hidden><center>Tu rol de usuario es: <span id="rolUsuario"></span></center></h2>
        </header>
        <main class="areaprincipal">
            <div>
                <h2 style="color: #ffff;"><center>Modificar Estado del Área</center></h2>
                <table border="1">
                    <tr>
                        <td colspan="2" style="background-color: #FF6B35; color: #fff; text-align: center;">
                            Datos del proyecto, contrato y estado
                        </td>
                    </tr>
                    <tr>
                        <td>Proyecto:</td>
                        <td><span id="proyecto-numero"></span></td>
                    </tr>
                    <tr>
                        <td hidden>Área:</td>
                        <td hidden><span id="area-nombre"></span></td>
                    </tr>
                    <tr>
                        <td>Contrato:</td>
                        <td><span id="contrato-numero"></span></td>
                    </tr>
                    <tr>
                        <td>Estado actual:</td>
                        <td><span id="estadoactual"></span></td>
                    </tr>
                </table>
                <br><br>
                <form id="formModificarEstado" style="font-weight: bold;">
                    <center>
                        <label for="nuevoEstado" style="color: #fff;">Nuevo Estado:</label>
                        <select id="nuevoEstado" name="nuevoEstado">
                            <option value="2">En Proceso</option>
                            <option value="3">Atrasado</option>
                            <option value="4">Finalizado</option>
                        </select>
                        <input type="hidden" id="areaId" name="areaId">
                        <input type="hidden" id="contratoId" name="contratoId">
                        <input type="hidden" id="proyectoId" name="proyectoId">
                        <br><br>
                        <button type="submit" class="botonpagina">Guardar</button>
                    </center>
                </form>
        </div>
        </main>
    </div>

    <script>
        
        document.addEventListener('DOMContentLoaded', async (event) => {
            const urlParams = new URLSearchParams(window.location.search);
            const areaId = urlParams.get('areaId');
            const contratoId = urlParams.get('contratoId');
            const proyectoId = urlParams.get('proyectoId');
            const estadoactual = urlParams.get('estadoActual'); // Cambié 'estado' a 'estadoActual'

            // Mostrar los datos del proyecto, área y contrato
            document.getElementById('proyecto-numero').textContent = proyectoId;
            document.getElementById('area-nombre').textContent = `Área ${areaId}`;
            document.getElementById('contrato-numero').textContent = contratoId;
            document.getElementById('estadoactual').textContent = estadoactual; // Mostrar estado actual

            // Asignar valores a los campos ocultos del formulario
            document.getElementById('areaId').value = areaId;
            document.getElementById('contratoId').value = contratoId;
            document.getElementById('proyectoId').value = proyectoId;
        });

        document.getElementById('formModificarEstado').addEventListener('submit', async (event) => {
            event.preventDefault();
        
            // Obtener los valores seleccionados y ocultos del formulario
            const nuevoEstado = document.getElementById('nuevoEstado').value;
            const areaId = document.getElementById('areaId').value;
            const contratoId = document.getElementById('contratoId').value;
            const proyectoId = document.getElementById('proyectoId').value;
        
            // Mostrar en consola los datos que se enviarán
            console.log('Datos a enviar:', { id_area: areaId, nuevo_estado: nuevoEstado, id_contrato: contratoId, id_proyecto: proyectoId });
        
            try {
                // Enviar la solicitud PUT al endpoint /api/estadoa para actualizar el estado del área actual
                const response = await fetch('/api/estadoa', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id_area: areaId, nuevo_estado: nuevoEstado, id_contrato: contratoId, id_proyecto: proyectoId })
                });
        
                if (response.ok) {
                    // Mostrar alerta de éxito
                    alert('Estado modificado con éxito');
        
                    // Verificar si el nuevo estado es "Finalizado" (id_estado = 4)
                    if (nuevoEstado === '4') {
                        if (parseInt(areaId) === 5) {
                            // Actualizar el estado del proyecto y contrato cuando el área 5 se finaliza
                            try {
                                const updateProyectoResponse = await fetch(`/api/proyectos/${proyectoId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ id_estado: '4' }) // O el campo y valor que necesites actualizar
                                });
        
                                const updateContratoResponse = await fetch(`/api/contratos/${contratoId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ id_estado: '4' }) // O el campo y valor que necesites actualizar
                                });
        
                                if (updateProyectoResponse.ok && updateContratoResponse.ok) {
                                    alert('Proyecto y Contrato actualizados a "Finalizado"');
                                } else {
                                    console.error('Error al actualizar el proyecto o contrato');
                                    alert('Error al actualizar el proyecto o contrato');
                                }
                            } catch (error) {
                                console.error('Error al enviar la solicitud:', error);
                                alert('Error al actualizar el proyecto o contrato');
                            }
                        } else {
                            // Actualizar el siguiente área a "En Proceso" (id_estado = 2) si el área no es 5
                            const siguienteAreaId = parseInt(areaId) + 1; // Obtener el siguiente área
        
                            const siguienteResponse = await fetch('/api/estadoa', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ id_area: siguienteAreaId, nuevo_estado: '2', id_contrato: contratoId, id_proyecto: proyectoId })
                            });
        
                            if (siguienteResponse.ok) {
                                alert('Siguiente área actualizada a "En Proceso"');
                            } else {
                                const errorResponse = await siguienteResponse.json();
                                console.error('Error en la respuesta del servidor:', errorResponse);
                                alert(`Error al actualizar el siguiente área: ${errorResponse.error}`);
                            }
                        }
                    }
        
                    window.location.href = './area.html'; // Redirigir después de procesar las actualizaciones
                } else {
                    // Manejar errores y mostrar mensaje de error
                    const errorResponse = await response.json();
                    console.error('Error en la respuesta del servidor:', errorResponse);
                    alert(`Error al modificar el estado: ${errorResponse.error}`);
                }
            } catch (error) {
                // Capturar errores de solicitud y mostrar mensaje de error
                console.error('Error al enviar la solicitud:', error);
                alert('Error al modificar el estado');
            }
        });
        
        
        
        document.addEventListener('DOMContentLoaded', async (event) => {
            const nombreUsuario = localStorage.getItem('nombreUsuario');
            if (nombreUsuario) {
              document.getElementById('nombreUsuario').innerText = nombreUsuario;
            }    
        });
        const rolUsuario = localStorage.getItem('idRol');
        if (rolUsuario) {
          document.getElementById('rolUsuario').innerText = rolUsuario;
        }

    </script>
</body>
</html>
