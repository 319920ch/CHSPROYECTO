<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soluciones Metálicas - Nuevo Contrato</title>
    <link rel="stylesheet" href="../static/style/App.css">
    <link rel="stylesheet" href="../static/style/modal.css">
    <link rel="stylesheet" href="../static/style/tablas.css">
    <link rel="stylesheet" href="../static/style/forms.css">
    <link rel="stylesheet" href="../static/style/tabla2.css">
    <link rel="icon" href="../static/image/favicon.ico" type="image/x-icon">
  </head>
  <body>
    <div class="encabezado" >
      <header class="headerprincipal" style="height: 100px;">
      <table>
        <td style="width: fit-content;">
          <div class="imglogo">
            <a href="./gerente.html">
              <img src="../static/image/LOGO.jpeg" alt="Logo" class="logo-img" />
            </a>
          </div>
          <td style="width: 120%">
          <h1 class="bienvenida"><center>¡Bienvenido <span id="nombreUsuario"></span></center> !</h1>
          <h2 class="rolUsuario" hidden><center>Tu rol de usuario es: <span id="rolUsuario"></span></center></h2>
        </td>
        <td style="width: fit-content;">
          <div class="menu-hamburguesa" onclick="toggleMenu()">
            <div class="linea"></div>
            <div class="linea"></div>
            <div class="linea"></div>
          </div>
          <nav id="menu">
            <ul>
              <li><a href="./gerente.html">Página de Bienvenida</a></li>
              <li><a href="./nuevocontrato.html">Nuevo Contrato</a></li>
              <li><a href="./listadocontrato.html">Modificar Presupuestos</a></li>
              <li><a href="./estadocontratos.html">Estado de Contratos</a></li>
              <li><a href="./infocontrato.html">Informes</a></li>
              <li><a href="./index.html">Cerrar Sesión</a></li>
            </ul>
          </nav>
        </td>
      </table>
      </header>
      
        <main class="main-content">
          <form id="nuevoContratoForm" class="form-container" style="float: 50%;">
            <h2 class="form-title">Nuevo contrato</h2>
            <div class="form-group">
              <label for="cliente" class="form-label">Cliente:</label>
              <input id="cliente" type="text" class="form-input" placeholder="Ingrese nombre del cliente">
            </div>
            <div class="form-group">
              <label for="presupuesto" class="form-label">Presupuesto:</label>
              <input id="presupuesto" type="text" class="form-input" placeholder="Ingrese presupuesto">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha de Inicio:</label>
              <input type="date" id="fecha_inicio" class="form-input"> <br>
            <div class="form-group"> <br>
              <label class="form-label">Fecha de Fin:</label>
              <input type="date" id="fecha_fin" class="form-input">
            </div>
            <button type="submit" class="submit-button" onclick="handleNuevoContrato(event)">Registrar Contrato</button>
          </form>      
          <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const nombreUsuario = localStorage.getItem('nombreUsuario');
                if (nombreUsuario) {
                  document.getElementById('nombreUsuario').innerText = nombreUsuario;
                 
            }});
            async function handleNuevoContrato(event) {
              event.preventDefault(); 
          
              const cliente = document.getElementById('cliente').value;
              const presupuesto = document.getElementById('presupuesto').value;
              const fechaInicio = document.getElementById('fecha_inicio').value;
              const fechaFin = document.getElementById('fecha_fin').value;
              
              const datos = {
                  cliente,
                  presupuesto,
                  fecha_inicio: fechaInicio,
                  fecha_fin: fechaFin
              };
          
              if (!cliente || !presupuesto || !fechaInicio || !fechaFin) {
                  alert('Por favor, complete todos los campos requeridos');
                  return;
              } else {
                  try {
                      const response = await fetch('/api/initC/iniciar', {
                          method: "POST",
                          headers: {
                              "Content-Type": "application/json",
                          },
                          body: JSON.stringify(datos)
                      });
          
                      if (response.ok) {
                          const data = await response.json();
                          const id_contrato = data.id_contrato; 
                          const presupuesto = data.presupuesto;
                          alert('Contrato creado con éxito');
                          // Redirige a la página de nuevo proyecto con los parámetros del contrato
                          window.location.href = `./nuevoproyecto.html?contratoId=${id_contrato}&presupuesto=${presupuesto}&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                      }  else {
                          const errorMessage = await response.text();
                          alert(`Error al crear contrato: ${errorMessage}`);
                      }
                  } catch (error) {
                      alert('Error al crear contrato. Verifica los datos ingresados.');
                  }
              }
          }
          document.getElementById('fecha_inicio').min = new Date().toISOString().split('T')[0];
          const maxDate = new Date();
    maxDate.setFullYear(maxDate.getFullYear() + 1); // Sumar un año

    document.getElementById('fecha_fin').max = maxDate.toISOString().split('T')[0];
    function toggleMenu() {
      const menu = document.getElementById('menu');
      if (menu.style.display === 'block') {
        menu.style.display = 'none';
      } else {
        menu.style.display = 'block';
      }
    }
          </script>
</body>
</html>