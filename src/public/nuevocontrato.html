<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soluciones Metálicas - Nuevo Contrato</title>
    <link rel="stylesheet" href="../static/style/App.css">
    <link rel="stylesheet" href="../static/style/modal.css">
    <link rel="stylesheet" href="../static/style/tablas.css">
    <link rel="stylesheet" href="../static/style/forms.css">
    <link rel="icon" href="../static/image/favicon.ico" type="image/x-icon">
  </head>
  <body>
        <header class="header">
          <a href="./gerente.html">
            <img src="../static/image/LOGO.jpeg" alt="Logo" class="logo">
        </a>
          <h1 class="title">SOLUCIONES METÁLICAS</h1>
        </header>
      
        <main class="main-content">
          <form id="nuevoContratoForm" class="form-container">
            <h2 class="form-title">Nuevo contrato</h2>
            <div class="form-group">
              <label for="cliente" class="form-label">Cliente:</label>
              <input id="cliente" type="text" class="form-input" placeholder="Ingrese nombre del cliente">
            </div>
            <div class="form-group">
              <label for="presupuesto" class="form-label">Presupuesto:</label>
              <input id="presupuesto" type="text" class="form-input" placeholder="Ingrese presupuesto">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha de Inicio:</label>
              <input type="date" id="fecha_inicio" class="form-input" min="<?php echo date('Y-m-d'); ?>">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha de Fin:</label>
              <input type="date" id="fecha_fin" class="form-input" max="<?php echo date('Y-m-d', strtotime('+1 year')); ?>">
            </div>
            <button type="submit" class="submit-button" onclick="handleNuevoContrato(event)">Registrar Contrato</button>
          </form>      
          <script>
            async function handleNuevoContrato(event) {
              event.preventDefault(); 
          
              const cliente = document.getElementById('cliente').value;
              const presupuesto = document.getElementById('presupuesto').value;
              const fechaInicio = document.getElementById('fecha_inicio').value;
              const fechaFin = document.getElementById('fecha_fin').value;
              
              const [añoi, mesi, diai] = fechaInicio.split('-');
              const [añof, mesf, diaf] = fechaFin.split('-');

              const datos = {
                cliente,
                presupuesto,
                fecha_inicio: fechaInicio,
                fecha_fin: fechaFin
              };
          
              if (!cliente || !presupuesto || !fechaInicio || !fechaFin) {
                alert('Por favor, complete todos los campos requeridos');
                return;
              } else {
                try {
                  const response = await fetch('/api/initC/iniciar', {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(datos)
                  });
          
                  if (response.ok) {
                    const data = await response.json();
                    const id_contrato = data.id_contrato; 
                    alert('Contrato creado con éxito');
                    window.location.href = `./nuevoproyecto.html?contratoId=${id_contrato}`;
                  }  else {
                    const errorMessage = await response.text();
                    alert(`Error al crear contrato: ${errorMessage}`);
                  }
                } catch (error) {
                  alert('Error al crear contrato. Verifica los datos ingresados.');
                }
              }
            }
          </script>
</body>
</html>